function hasClass(elem,cls){cls=cls||'';if(cls.replace(/\s/g,'').length===0)return false;let ret=new RegExp(' '+cls+'').test(''+elem.className+'');return ret}function addClass(elements,cName){if(!hasClass(elements,cName)){elements.className+=" "+cName}}function removeClass(elements,cName){if(hasClass(elements,cName)){elements.className=elements.className.replace(new RegExp("(\\s|^)"+cName+"(\\s|$)")," ")}}function appendHTML(o,html){let divTemp=document.createElement("div");let nodes=null;let fragment=document.createDocumentFragment();divTemp.innerHTML=html;nodes=divTemp.childNodes;for(let i=0,length=nodes.length;i<length;i++){fragment.appendChild(nodes[i].cloneNode(true))}o.appendChild(fragment);nodes=null;fragment=null}if(!document.getElementsByClassName){document.getElementsByClassName=function(className,index){let nodes=document.getElementsByTagName("*");let arr=[];for(let i=0;i<nodes.length;i++){if(hasClass(nodes[i],className)){arr.push(nodes[i])}}if(index===undefined)index=0;return index===-1?arr:arr[index]}}var _ajax=function(){};_ajax.prototype={request:function(method,url,callback,postVars){let xhr=this.createXhrObject()();xhr.onreadystatechange=function(){if(xhr.readyState!==4)return;(xhr.status===200)?callback.success(xhr.responseText,xhr.responseXML):callback.failure(xhr,xhr.status)};if(method!=="POST"&&postVars){url+="?"+this.JSONStringify(postVars);postVars=null}xhr.open(method,url,true);xhr.send(postVars)},createXhrObject:function(){let methods=[function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(let i=0,len=methods.length;i<len;i++){try{return methods[i]}catch(e){continue}}throw new Error("ajax created failure");},JSONStringify:function(obj){return JSON.stringify(obj).replace(/"|{|}/g,"").replace(/b:b/g,"=").replace(/b,b/g,"&")}};var tncode={_obj:null,_tncode:null,_img:null,_img_loaded:false,_is_draw_bg:false,_is_moving:false,_block_start_x:0,_block_start_y:0,_doing:false,_mark_w:50,_mark_h:50,_mark_offset:0,_img_w:240,_img_h:150,_result:false,_err_c:0,_onSuccess:null,_onFail:null,_options:{},_bind:function(elm,evType,fn){if(elm.addEventListener){elm.addEventListener(evType,fn);return true}else if(elm.attachEvent){var r=elm.attachEvent("on"+evType,fn);return r}},_block_start_move:function(e){if(tncode._doing||!tncode._img_loaded){return}e.preventDefault();let theEvent=e||window.event;if(theEvent.touches){theEvent=theEvent.touches[0]}console.log("_block_start_move");let obj=document.getElementsByClassName('slide_block_text')[0];obj.style.display="none";tncode._draw_bg();tncode._block_start_x=theEvent.clientX;tncode._block_start_y=theEvent.clientY;tncode._doing=true;tncode._is_moving=true},_block_on_move:function(e){if(!tncode._doing)return true;if(!tncode._is_moving)return true;e.preventDefault();let theEvent=e||window.event;if(theEvent.touches){theEvent=theEvent.touches[0]}tncode._is_moving=true;console.log("_block_on_move");let offset=theEvent.clientX-tncode._block_start_x;if(offset<0){offset=0}let max_off=tncode._img_w-tncode._mark_w;if(offset>max_off){offset=max_off}let obj=document.getElementsByClassName('slide_block')[0];obj.style.cssText="transform: translate("+offset+"px, 0px)";tncode._mark_offset=offset/max_off*(tncode._img_w-tncode._mark_w);tncode._draw_bg();tncode._draw_mark()},_block_on_end:function(e){if(!tncode._doing)return true;e.preventDefault();let theEvent=e||window.event;if(theEvent.touches){theEvent=theEvent.touches[0]}console.log("_block_on_end");tncode._is_moving=false;tncode._send_result()},_send_result:function(){let haddle={success:tncode._send_result_success,failure:tncode._send_result_failure};tncode._result=false;let re=new _ajax();re.request('get',tncode._options.checkUrl+'?tn_r='+tncode._mark_offset,haddle)},_send_result_success:function(responseText,responseXML){tncode._doing=false;if(responseText==='ok'){tncode._tncode.innerHTML='✓ 验证成功';tncode._showmsg('✓ 验证成功',1);tncode._result=true;document.getElementsByClassName('hgroup')[0].style.display="block";setTimeout(tncode.hide,3000);if(tncode._onSuccess){tncode._onSuccess()}}else{let obj=document.getElementById('tncode_div');addClass(obj,'dd');setTimeout(function(){removeClass(obj,'dd')},200);tncode._result=false;tncode._showmsg('验证失败');tncode._err_c++;setTimeout(tncode.refresh(),600);if(tncode._onFail){tncode._onFail()}}},_send_result_failure:function(xhr,status){},_draw_fullbg:function(){let canvas_bg=document.getElementsByClassName('tncode_canvas_bg')[0];let ctx_bg=canvas_bg.getContext('2d');ctx_bg.drawImage(tncode._img,0,tncode._img_h*2,tncode._img_w,tncode._img_h,0,0,tncode._img_w,tncode._img_h)},_draw_bg:function(){if(tncode._is_draw_bg){return}tncode._is_draw_bg=true;let canvas_bg=document.getElementsByClassName('tncode_canvas_bg')[0];let ctx_bg=canvas_bg.getContext('2d');ctx_bg.drawImage(tncode._img,0,0,tncode._img_w,tncode._img_h,0,0,tncode._img_w,tncode._img_h)},_draw_mark:function(){let canvas_mark=document.getElementsByClassName('tncode_canvas_mark')[0];let ctx_mark=canvas_mark.getContext('2d');ctx_mark.clearRect(0,0,canvas_mark.width,canvas_mark.height);ctx_mark.drawImage(tncode._img,0,tncode._img_h,tncode._mark_w,tncode._img_h,tncode._mark_offset,0,tncode._mark_w,tncode._img_h);let imageData=ctx_mark.getImageData(0,0,tncode._img_w,tncode._img_h);let data=imageData.data;let x=tncode._img_h,y=tncode._img_w;for(let j=0;j<x;j++){let ii=1,k1=-1;for(let k=0;k<y&&k>=0&&k>k1;){let i=(j*y+k)*4;k+=ii;let r=data[i],g=data[i+1],b=data[i+2];if(r+g+b<200){data[i+3]=0}else{let arr_pix=[1,-5];let arr_op=[250,0];for(let i=1;i<arr_pix[0]-arr_pix[1];i++){let iiii=arr_pix[0]-1*i;let op=parseInt(arr_op[0]-(arr_op[0]-arr_op[1])/(arr_pix[0]-arr_pix[1])*i);let iii=(j*y+k+iiii*ii)*4;data[iii+3]=op}if(ii===-1){break}k1=k;k=y-1;ii=-1}}}ctx_mark.putImageData(imageData,0,0)},_reset:function(){tncode._mark_offset=0;tncode._draw_bg();tncode._draw_mark();let obj=document.getElementsByClassName('slide_block')[0];obj.style.cssText="transform: translate(0px, 0px)"},show:function(){let obj=document.getElementsByClassName('hgroup')[0];if(obj){obj.style.display="none"}tncode.refresh();tncode._tncode=this;document.getElementById('tncode_div_bg').style.display="block";document.getElementById('tncode_div').style.display="block"},hide:function(){document.getElementById('tncode_div_bg').style.display="none";document.getElementById('tncode_div').style.display="none"},_showmsg:function(msg,status){let obj;if(!status){status=0;obj=document.getElementsByClassName('tncode_msg_error')[0]}else{obj=document.getElementsByClassName('tncode_msg_ok')[0]}obj.innerHTML=msg;function setOpacity(ele,opacity){if(ele.style.opacity!==undefined){ele.style.opacity=opacity/100}else{ele.style.filter="alpha(opacity="+opacity+")"}}function fadeout(ele,opacity,speed){if(ele){let v=ele.style.filter.replace("alpha(opacity=","").replace(")","")||ele.style.opacity||100;v<1&&(v=v*100);let count=speed/1000;let avg=(100-opacity)/count;let timer=null;timer=setInterval(function(){if(v-avg>opacity){v-=avg;setOpacity(ele,v)}else{setOpacity(ele,0);if(status===0){tncode._reset()}clearInterval(timer)}},100)}}function fadein(ele,opacity,speed){if(ele){let v=ele.style.filter.replace("alpha(opacity=","").replace(")","")||ele.style.opacity;v<1&&(v=v*100);let count=speed/1000;let avg=count<2?(opacity/count):(opacity/count-1);let timer=null;timer=setInterval(function(){if(v<opacity){v+=avg;setOpacity(ele,v)}else{clearInterval(timer);setTimeout(function(){fadeout(obj,0,6000)},1000)}},100)}}fadein(obj,80,4000)},_html:function(){let d=document.getElementById('tncode_div_bg');if(d)return;let html='<div class="tncode_div_bg" id="tncode_div_bg"></div><div class="tncode_div" id="tncode_div"><div class="loading">加载中</div><canvas class="tncode_canvas_bg"></canvas><canvas class="tncode_canvas_mark"></canvas><div class="hgroup"></div><div class="tncode_msg_error"></div><div class="tncode_msg_ok"></div><div class="slide"><div class="slide_block"></div><div class="slide_block_text">拖动左边滑块完成上方拼图</div></div><div class="tools"><div class="tncode_close"></div><div class="tncode_refresh"></div><div class="tncode_tips"><a href="//weisifang.com" target=_blank>by 威四方</a></div></div></div>';let bo=document.getElementsByTagName('body')[0];appendHTML(bo,html)},_currentUrl:function(){let list=document.getElementsByTagName('script');for(let i in list){let d=list[i];if(d.src.indexOf('tn_code')!==-1){let arr=d.src.split('tn_code');return arr[0]}}},refresh:function(){let isSupportWebp=!![].map&&document.createElement('canvas').toDataURL('image/webp').indexOf('data:image/webp')===0;let _this=this;tncode._err_c=0;tncode._is_draw_bg=false;tncode._result=false;tncode._img_loaded=false;let obj=document.getElementsByClassName('tncode_canvas_bg')[0];obj.style.display="none";obj=document.getElementsByClassName('tncode_canvas_mark')[0];obj.style.display="none";tncode._img=new Image();let img_url=tncode._options.getImgUrl+"?t="+Math.random();if(!isSupportWebp){img_url+="&nowebp=1"}tncode._img.src=img_url;tncode._img.onload=function(){tncode._draw_fullbg();let canvas_mark=document.getElementsByClassName('tncode_canvas_mark')[0];let ctx_mark=canvas_mark.getContext('2d');ctx_mark.clearRect(0,0,canvas_mark.width,canvas_mark.height);tncode._img_loaded=true;obj=document.getElementsByClassName('tncode_canvas_bg')[0];obj.style.display="";obj=document.getElementsByClassName('tncode_canvas_mark')[0];obj.style.display=""};let obj1=document.getElementsByClassName('slide_block')[0];obj1.style.cssText="transform: translate(0px, 0px)";obj1=document.getElementsByClassName('slide_block_text')[0];obj1.style.display="block"},init:function(options={}){tncode._options=Object.assign({},{handleDom:'.tncode',getImgUrl:'./get_img.php',checkUrl:'./check.php'},options);let _this=this;if(!tncode._img){tncode._html();let obj=document.getElementsByClassName('slide_block')[0];tncode._bind(obj,'mousedown',_this._block_start_move);tncode._bind(document,'mousemove',_this._block_on_move);tncode._bind(document,'mouseup',_this._block_on_end);tncode._bind(obj,'touchstart',_this._block_start_move);tncode._bind(document,'touchmove',_this._block_on_move);tncode._bind(document,'touchend',_this._block_on_end);let obj1=document.getElementsByClassName('tncode_close')[0];tncode._bind(obj1,'touchstart',_this.hide);tncode._bind(obj1,'click',_this.hide);let obj2=document.getElementsByClassName('tncode_refresh')[0];tncode._bind(obj2,'touchstart',_this.refresh);tncode._bind(obj2,'click',_this.refresh);let objs=document.querySelectorAll(tncode._options.handleDom,-1);for(let i in objs){let o=objs[i];o.innerHTML='点击按钮进行验证';tncode._bind(o,'touchstart',_this.show);tncode._bind(o,'click',_this.show)}}return tncode},result:function(){return tncode._result},onSuccess:function(fn){tncode._onSuccess=fn;return tncode},onFail:function(fn){tncode._onFail=fn;return tncode}};var $TN=tncode;let _old_onload=window.onload;window.onload=function(){if(typeof _old_onload==='function'){_old_onload()}};
